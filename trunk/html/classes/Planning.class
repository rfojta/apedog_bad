<?php
/* 
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */

/**
 * Description of Planning
 *
 * @author Richard
 */
class Planning {
    private $dbres;

    private $term_id;
    private $lc_id;
    private $tracking;

    private $area_query = 'select * from areas';
    private $kpi_query = 'select * from kpis where area = ';

    function Planning( $dbres, $term_id, $user ) {
        $this->dbres = $dbres;
        $this->term_id = $term_id;

        $lc = new LC($dbres);
        $this->lc_id = $lc->get_lc_by_user($user);

        $this->tracking = new Tracking($dbres);

    }

    function get_area_list() {
        $query = $this->area_query;

        $res = mysql_query( $query, $this->dbres );
        if( !$res ) {
            die( 'Invalid query: ' . mysql_error($this->dbres) );
        }

        $out_array = array();

        while( $row = mysql_fetch_assoc($res) ) {
            $out_array[] = $row;
        }

        return $out_array;
    }

    function get_kpis ($area_id ) {
        $query = $this->kpi_query  
            . mysql_real_escape_string($area_id, $this->dbres);

        $res = mysql_query( $query, $this->dbres );
        if( !$res ) {
            die( 'Invalid query: ' . mysql_error($this->dbres) );
        }

        $out_array = array();

        while( $row = mysql_fetch_assoc($res) ) {
            $out_array[] = $row;
        }

        return $out_array;
    }

    function get_form_content() {
        $area_list = $this->get_area_list();
        $current_term = $this->term_id;
        $lc_id = $this->lc_id;

        echo "<ul>\n";
        foreach( $area_list as $row ) {
            $area_id = $row['id'];
            echo '<li>';
            echo "\n";
            echo $row['name'] . ': ';
            $actual = $this->tracking->get_actual(
                $lc_id, $current_term, $area_id
            );

            echo '<input name="'
                . $lc_id . '-'
                . $current_term . '-'
                . $area_id .'" value="' . $actual . '">';
            echo "\n";
            echo '</li>';
            echo "\n";
        }
        echo "</ul>\n";
    }

    function submit( $post ) {
        foreach( $post as $key => $value ) {
        // $tokens = array();
            if( preg_match('/^(\d)-(\d)-(\d)$/', $key, $tokens) ) {
                if( $value > 0 ) {
                    $this->tracking->set_actual(
                        $tokens[1], $tokens[2],
                        $tokens[3], $value);
                }
            }
        }
    }
}

?>
